# This is used to store files that indicate that an operation has been run. Note that if you change this after you have
# run the script, you may clobber your previous install and/or other bad things. I do not know if if /etc/ansible is
# the best place to put these files but I wanted to avoid home directories in case the user that runs ansible ever changes.
auth_ansible_dir: /etc/ansible/packages

# Note I am prefixing this plugin with my own package name in case it may ever conflict with someone elses auth package.
auth_dir: $auth_ansible_dir/spectr.us/auth


auth_create_user_and_groups_done: $auth_dir/create-users-and-groups
auth_create_indexes_done: $auth_dir/create-indexes
auth_create_autofs_done: $auth_dir/create-autofs
auth_create_automount_done: $auth_dir/create-automount
auth_create_sudo_done: $auth_dir/create-sudo
auth_create_sudo_master_done: $auth_dir/create-sudo-master



- name: Copy over the indexes ldif
  template: src=templates/tmp/create_indexes.ldif.j2 dest=/tmp/create_indexes.ldif owner=root group=root
  tags: 
    - ldap
    - auth

- name: Install indexes
  shell: ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f create_indexes.ldif && touch $auth_create_indexes_done chdir=/tmp creates=$auth_create_indexes_done
  tags: 
    - ldap
    - auth

- name: Copy over the autofs ldif
  template: src=templates/tmp/create_autofs.ldif.j2 dest=/tmp/create_autofs.ldif owner=root group=root
  tags: 
    - ldap
    - auth

- name: Install autofs
  shell: ldapadd -Y EXTERNAL -H ldapi:/// -f create_autofs.ldif && touch $auth_create_autofs_done chdir=/tmp creates=$auth_create_autofs_done
  tags: 
    - ldap
    - auth

- name: Copy over the automount ldif
  template: src=templates/tmp/create_automount.ldif.j2 dest=/tmp/create_automount.ldif owner=root group=root
  tags: 
    - ldap
    - auth

- name: Install automount
  shell: ldapadd -w $ldapPassword -x -D cn=admin,$dc -f create_automount.ldif && touch $auth_create_automount_done chdir=/tmp creates=$auth_create_automount_done
  tags: 
    - ldap
    - auth

- name: Copy over the sudo ldif
  template: src=templates/tmp/create_sudo.ldif.j2 dest=/tmp/create_sudo.ldif owner=root group=root
  tags: 
    - ldap
    - auth

- name: Install sudo
  shell: ldapadd -Y EXTERNAL -H ldapi:/// -f create_sudo.ldif && touch $auth_create_sudo_done chdir=/tmp creates=$auth_create_sudo_done
  tags: 
    - ldap
    - auth

- name: Copy over the sudo master ldif
  template: src=templates/tmp/create_sudo_master.ldif.j2 dest=/tmp/create_sudo_master.ldif owner=root group=root
  tags: 
    - ldap
    - auth

- name: Install sudo master
  shell: ldapadd -w $ldapPassword -x -D cn=admin,$dc -f create_sudo_master.ldif && touch $auth_create_sudo_master_done chdir=/tmp creates=$auth_create_sudo_master_done
  tags: 
    - ldap
    - auth
